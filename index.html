<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Vocabulary Learning System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background-color: #767ae6;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
        }

        .sidebar h1 {
            padding: 0 20px 5px 20px;
            font-size: 1.2rem;                                  /* smaller than default 1.5rem */
            border-bottom: 1px solid #767ae6;
            margin-bottom: 10px;
            text-align: center;
        }

        .sidebar-pic {
            display: block;
            margin: 0 auto 10px auto;
            width: 150px;
            height: auto;
        }

        .sidebar-footer {
            position: absolute; /* anchor to bottom of fixed sidebar */
            bottom: 20px;
            left: 0;
            right: 0;
            margin: 0 auto;
            display: block;
            width: 150px;
            height: auto;
        }



        .nav-item {
            display: block;
            width: 100%;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            border: none;
            background: none;
            text-align: left;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .nav-item:hover {
            background-color: #c1c3ff;
        }

        .nav-item.active {
            background-color: #b3b5ff;
            border-right: 4px solid #b3b5ff;
        }

        /* Main Content Area */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex: 1;
        }

        .content-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            margin-right: 0;
        }

        .content-body {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
            margin-right: 0;
        }

        /* Dashboard Specific Styles */
        .dashboard-welcome {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-welcome h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .dashboard-welcome p {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .quick-actions {
            text-align: center;
        }

        .quick-actions h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            background-color: #27ae60;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .action-btn:hover {
            background-color: #229954;
        }

        /* Vocabulary and Category Styles */
        .vocab-header, .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filters select, .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .phrase-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .vocab-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .vocab-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .vocab-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .thai-word {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .pronunciation {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .translation {
            font-size: 1.1rem;
            color: #34495e;
            margin: 10px 0;
        }

        .example {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-style: italic;
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        .progress-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .progress-new { background: #e74c3c; color: white; }
        .progress-recognise { background: #f39c12; color: white; }
        .progress-recall { background: #3498db; color: white; }
        .progress-confident { background: #27ae60; color: white; }
        .progress-basic { background: #e74c3c; color: white; }
        .progress-intermediate { background: #f39c12; color: white; }
        .progress-advanced { background: #27ae60; color: white; }

        .category-badge {
            background: #95a5a6;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .card-btn:hover {
            background: #ecf0f1;
        }

        .edit-btn { color: #3498db; }
        .delete-btn { color: #e74c3c; }

        /* Category List Styles */
        .category-list {
            display: grid;
            gap: 15px;
        }

        .category-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-info h3 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .category-info p {
            margin: 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .category-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .edit-category-btn {
            background: #3498db;
            color: white;
        }

        .delete-category-btn {
            background: #e74c3c;
            color: white;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-content input, .modal-content textarea, .modal-content select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .modal-content textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .action-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .card-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .category-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
                padding: 20px;
            }
            
            .vocab-header, .category-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters {
                flex-wrap: wrap;
            }
            
            .vocab-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <h1>Thai Handbook</h1>

        <img src="Images/book.png" alt="Thai Handbook Pic" class="sidebar-pic">

        <button class="nav-item active" onclick="showDashboard()">🏠 Home</button>
        <button class="nav-item" onclick="showVocabulary()">📘 Vocab</button>
        <button class="nav-item" onclick="showPhrases()">💬 Phrases</button>
        <button class="nav-item" onclick="showTemplates()">📝 Templates</button>
        <button class="nav-item" onclick="showCategories()">🏷️ Categories</button>
        <button class="nav-item" onclick="logoutUser()" style="border-top: 1px solid #34495e; margin-top: 20px;">🚪 Logout</button>

    <img src="Images/book-row.png" alt="Footer Image" class="sidebar-footer">

    </nav>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: block; z-index: 2000;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3>🔐 Login to Joey's Thai Handbook</h3>
            <form id="login-form" onsubmit="loginUser(event)">
                <input type="email" id="login-email" placeholder="Email" required style="width: 100%; margin-bottom: 15px;">
                <input type="password" id="login-password" placeholder="Password" required style="width: 100%; margin-bottom: 15px;">
                <button type="submit" class="action-btn" id="login-btn">Login</button>
                <div id="login-error" style="color: #e74c3c; margin-top: 10px; display: none;"></div>
            </form>
        </div>
    </div>


    <!-- Main Content Area -->
    <main class="main-content">
        <div class="content-header">
            <h2 id="page-title">Dashboard</h2>
        </div>
        
        <div class="content-body" id="main-content">
            <div class="loading">Loading...</div>
        </div>
    </main>

    <!-- Firebase SDK -->
<script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        updateDoc, 
        deleteDoc, 
        doc, 
        getDocs,
        onSnapshot,
        query,
        orderBy 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    import { 
    getAuth, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // TODO: Replace with your Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyD4MxUq4-wYegdyi-djyclsEOtMI_Zd6sU",
        authDomain: "joeys-thai-handbook.firebaseapp.com",
        projectId: "joeys-thai-handbook",
        storageBucket: "joeys-thai-handbook.firebasestorage.app",
        messagingSenderId: "243508048527",
        appId: "1:243508048527:web:3b47165f6d1c2066f336fa",
        measurementId: "G-6B1LP117YN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Initialize auth (after app exists)
    const auth = getAuth(app);
    let currentUser = null;


    // Global variables
    let vocabulary = [];
    let phrases = [];
    let templates = [];
    let categories = [];
    let isLoading = false;

    // Authentication functions
    async function loginUser(event) {
        event.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-btn');
        const errorDiv = document.getElementById('login-error');
        
        // Show loading state
        loginBtn.textContent = 'Logging in...';
        loginBtn.disabled = true;
        errorDiv.style.display = 'none';
        
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            currentUser = userCredential.user;
            
            // Hide login modal
            document.getElementById('login-modal').style.display = 'none';
            
            // Load the app
            await loadAllData();
            showDashboard();
            
            console.log('Login successful!');
            
        } catch (error) {
            console.error('Login error:', error);
            errorDiv.style.display = 'block';
            errorDiv.textContent = getErrorMessage(error.code);
        } finally {
            loginBtn.textContent = 'Login';
            loginBtn.disabled = false;
        }
    }

    function getErrorMessage(errorCode) {
        switch(errorCode) {
            case 'auth/user-not-found':
                return 'No account found with this email';
            case 'auth/wrong-password':
                return 'Incorrect password';
            case 'auth/invalid-email':
                return 'Invalid email address';
            case 'auth/too-many-requests':
                return 'Too many failed attempts. Try again later.';
            default:
                return 'Login failed. Please try again.';
        }
    }

    // Logout function
    async function logoutUser() {
        try {
            await signOut(auth);
            currentUser = null;
            document.getElementById('login-modal').style.display = 'block';
            document.getElementById('main-content').innerHTML = '<div class="loading">Please login to continue...</div>';
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    // Check authentication state
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            console.log('User is signed in:', user.email);
        } else {
            currentUser = null;
            console.log('User is signed out');
        }
    });   

    // Make authentication functions globally accessible
    window.loginUser = loginUser;
    window.logoutUser = logoutUser;


    // Firebase helper functions
    async function loadAllData() {
        isLoading = true;
        try {
            showLoading();
            
            // Load all collections in parallel
            const [vocabSnapshot, phraseSnapshot, templateSnapshot, categorySnapshot] = await Promise.all([
                getDocs(collection(db, 'vocabulary')),
                getDocs(collection(db, 'phrases')),
                getDocs(collection(db, 'templates')),
                getDocs(collection(db, 'categories'))
            ]);

            vocabulary = vocabSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            phrases = phraseSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            templates = templateSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            categories = categorySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // If no categories exist, create default ones
            if (categories.length === 0) {
                await createDefaultCategories();
            }

            console.log('Data loaded:', { vocabulary: vocabulary.length, phrases: phrases.length, templates: templates.length, categories: categories.length });
            
        } catch (error) {
            console.error('Error loading data:', error);
            showError('Failed to load data. Please refresh the page.');
        } finally {
            isLoading = false;
            hideLoading();
        }
    }

    async function createDefaultCategories() {
        const defaultCategories = [
            { name: 'Food', description: 'Food and dining related words' },
            { name: 'Travel', description: 'Travel and transportation' },
            { name: 'Daily Life', description: 'Everyday conversation' }
        ];

        for (const category of defaultCategories) {
            try {
                const docRef = await addDoc(collection(db, 'categories'), category);
                categories.push({ id: docRef.id, ...category });
            } catch (error) {
                console.error('Error creating default category:', error);
            }
        }
    }

    function showLoading() {
        const content = document.getElementById('main-content');
        if (content) {
            content.innerHTML = '<div class="loading">Loading...</div>';
        }
    }

    function hideLoading() {
        // This will be handled by individual page functions
    }

    function showError(message) {
        const content = document.getElementById('main-content');
        if (content) {
            content.innerHTML = `<div class="error">${message}</div>`;
        }
    }

    // Vocabulary functions
    async function addWordToFirebase(wordData) {
        try {
            const docRef = await addDoc(collection(db, 'vocabulary'), {
                thai: wordData.thai,
                pronunciation: wordData.pronunciation,
                translation: wordData.translation,
                example: wordData.example || '',
                category: wordData.category,
                progress: wordData.progress,
                createdAt: new Date()
            });
            
            const newWord = { id: docRef.id, ...wordData, createdAt: new Date() };
            vocabulary.push(newWord);
            return newWord;
        } catch (error) {
            console.error('Error adding word:', error);
            throw error;
        }
    }

    async function updateWordInFirebase(wordId, wordData) {
        try {
            await updateDoc(doc(db, 'vocabulary', wordId), {
                thai: wordData.thai,
                pronunciation: wordData.pronunciation,
                translation: wordData.translation,
                example: wordData.example || '',
                category: wordData.category,
                progress: wordData.progress,
                updatedAt: new Date()
            });

            const wordIndex = vocabulary.findIndex(w => w.id === wordId);
            if (wordIndex !== -1) {
                vocabulary[wordIndex] = { id: wordId, ...wordData, updatedAt: new Date() };
            }
        } catch (error) {
            console.error('Error updating word:', error);
            throw error;
        }
    }

    async function deleteWordFromFirebase(wordId) {
        try {
            await deleteDoc(doc(db, 'vocabulary', wordId));
            vocabulary = vocabulary.filter(w => w.id !== wordId);
        } catch (error) {
            console.error('Error deleting word:', error);
            throw error;
        }
    }

    // Phrase functions
    async function addPhraseToFirebase(phraseData) {
        try {
            const docRef = await addDoc(collection(db, 'phrases'), {
                thai: phraseData.thai,
                pronunciation: phraseData.pronunciation,
                translation: phraseData.translation,
                context: phraseData.context || '',
                category: phraseData.category,
                progress: phraseData.progress,
                createdAt: new Date()
            });
            
            const newPhrase = { id: docRef.id, ...phraseData, createdAt: new Date() };
            phrases.push(newPhrase);
            return newPhrase;
        } catch (error) {
            console.error('Error adding phrase:', error);
            throw error;
        }
    }

    async function updatePhraseInFirebase(phraseId, phraseData) {
        try {
            await updateDoc(doc(db, 'phrases', phraseId), {
                thai: phraseData.thai,
                pronunciation: phraseData.pronunciation,
                translation: phraseData.translation,
                context: phraseData.context || '',
                category: phraseData.category,
                progress: phraseData.progress,
                updatedAt: new Date()
            });

            const phraseIndex = phrases.findIndex(p => p.id === phraseId);
            if (phraseIndex !== -1) {
                phrases[phraseIndex] = { id: phraseId, ...phraseData, updatedAt: new Date() };
            }
        } catch (error) {
            console.error('Error updating phrase:', error);
            throw error;
        }
    }

    async function deletePhraseFromFirebase(phraseId) {
        try {
            await deleteDoc(doc(db, 'phrases', phraseId));
            phrases = phrases.filter(p => p.id !== phraseId);
        } catch (error) {
            console.error('Error deleting phrase:', error);
            throw error;
        }
    }

    // Template functions
    async function addTemplateToFirebase(templateData) {
        try {
            const docRef = await addDoc(collection(db, 'templates'), {
                patternThai: templateData.patternThai,
                patternPronunciation: templateData.patternPronunciation,
                example: templateData.example || '',
                notes: templateData.notes || '',
                category: templateData.category,
                complexity: templateData.complexity,
                createdAt: new Date()
            });
            
            const newTemplate = { id: docRef.id, ...templateData, createdAt: new Date() };
            templates.push(newTemplate);
            return newTemplate;
        } catch (error) {
            console.error('Error adding template:', error);
            throw error;
        }
    }

    async function updateTemplateInFirebase(templateId, templateData) {
        try {
            await updateDoc(doc(db, 'templates', templateId), {
                patternThai: templateData.patternThai,
                patternPronunciation: templateData.patternPronunciation,
                example: templateData.example || '',
                notes: templateData.notes || '',
                category: templateData.category,
                complexity: templateData.complexity,
                updatedAt: new Date()
            });

            const templateIndex = templates.findIndex(t => t.id === templateId);
            if (templateIndex !== -1) {
                templates[templateIndex] = { id: templateId, ...templateData, updatedAt: new Date() };
            }
        } catch (error) {
            console.error('Error updating template:', error);
            throw error;
        }
    }

    async function deleteTemplateFromFirebase(templateId) {
        try {
            await deleteDoc(doc(db, 'templates', templateId));
            templates = templates.filter(t => t.id !== templateId);
        } catch (error) {
            console.error('Error deleting template:', error);
            throw error;
        }
    }

    // Category functions
    async function addCategoryToFirebase(categoryData) {
        try {
            const docRef = await addDoc(collection(db, 'categories'), {
                name: categoryData.name,
                description: categoryData.description || '',
                createdAt: new Date()
            });
            
            const newCategory = { id: docRef.id, ...categoryData, createdAt: new Date() };
            categories.push(newCategory);
            return newCategory;
        } catch (error) {
            console.error('Error adding category:', error);
            throw error;
        }
    }

    async function updateCategoryInFirebase(categoryId, categoryData) {
        try {
            await updateDoc(doc(db, 'categories', categoryId), {
                name: categoryData.name,
                description: categoryData.description || '',
                updatedAt: new Date()
            });

            const categoryIndex = categories.findIndex(c => c.id === categoryId);
            if (categoryIndex !== -1) {
                categories[categoryIndex] = { id: categoryId, ...categoryData, updatedAt: new Date() };
            }
        } catch (error) {
            console.error('Error updating category:', error);
            throw error;
        }
    }

    async function deleteCategoryFromFirebase(categoryId) {
        try {
            await deleteDoc(doc(db, 'categories', categoryId));
            categories = categories.filter(c => c.id !== categoryId);
            
            // Remove category from all items that reference it
            vocabulary = vocabulary.map(word => {
                if (word.category === categoryId) word.category = '';
                return word;
            });
            phrases = phrases.map(phrase => {
                if (phrase.category === categoryId) phrase.category = '';
                return phrase;
            });
            templates = templates.map(template => {
                if (template.category === categoryId) template.category = '';
                return template;
            });
        } catch (error) {
            console.error('Error deleting category:', error);
            throw error;
        }
    }

    // Navigation functions
    function setActiveNav(activeButton) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    window.showDashboard = function() {
        setActiveNav(document.querySelector('.nav-item'));
        document.getElementById('page-title').textContent = '🏠 Home';
        document.getElementById('main-content').innerHTML = `
            <div class="dashboard-welcome">
                <h1>Welcome to Joey's Thai Handbook</h1>
                <p>Lets actually be a confident billingual!</p>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="vocab-count">${vocabulary.length}</h3>
                    <p>Vocab Words</p>
                </div>
                <div class="stat-card">
                    <h3 id="phrase-count">${phrases.length}</h3>
                    <p>Phrases</p>
                </div>
                <div class="stat-card">
                    <h3 id="template-count">${templates.length}</h3>
                    <p>Sentence Templates</p>
                </div>
                <div class="stat-card">
                    <h3 id="category-count">${categories.length}</h3>
                    <p>Categories</p>
                </div>
            </div>

            <div class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="action-buttons">
                    <button class="action-btn" onclick="showVocabulary()">Add New Word</button>
                    <button class="action-btn" onclick="showPhrases()">Add New Phrase</button>
                    <button class="action-btn" onclick="showCategories()">Manage Categories</button>
                </div>
            </div>
        `;
    }

    window.showVocabulary = function() {
        setActiveNav(event.target);
        document.getElementById('page-title').textContent = 'Vocab Book';
        document.getElementById('main-content').innerHTML = `
            <div class="vocab-header">
                <button class="action-btn" onclick="showAddWordForm()" ${isLoading ? 'disabled' : ''}>+ Add New Word</button>
                
                <div class="filters">
                    <select id="category-filter" onchange="filterVocabulary()" ${isLoading ? 'disabled' : ''}>
                        <option value="">All Categories</option>
                    </select>
                    
                    <select id="progress-filter" onchange="filterVocabulary()" ${isLoading ? 'disabled' : ''}>
                        <option value="">All Progress Levels</option>
                        <option value="new">New</option>
                        <option value="recognise">Recognise</option>
                        <option value="recall">Recall</option>
                        <option value="confident">Confident</option>
                    </select>
                    
                    <input type="text" id="search-filter" placeholder="Search words..." onkeyup="filterVocabulary()" ${isLoading ? 'disabled' : ''}>
                </div>
            </div>

            <div class="vocab-grid" id="vocab-grid">
                <!-- Vocabulary cards will be populated here -->
            </div>

            <!-- Add Word Modal -->
            <div id="add-word-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeAddWordForm()">&times;</span>
                    <h3>Add New Word</h3>
                    <form id="add-word-form" onsubmit="addWord(event)">
                        <input type="text" id="thai-word" placeholder="Thai word" required>
                        <input type="text" id="pronunciation" placeholder="Pronunciation (English)" required>
                        <input type="text" id="translation" placeholder="English translation" required>
                        <textarea id="example" placeholder="Example usage (optional)"></textarea>
                        
                        <select id="word-category" required>
                            <option value="">Select Category</option>
                        </select>
                        
                        <select id="word-progress" required>
                            <option value="new">New</option>
                            <option value="recognise">Recognise</option>
                            <option value="recall">Recall</option>
                            <option value="confident">Confident</option>
                        </select>
                        
                        <button type="submit" class="action-btn">Add Word</button>
                    </form>
                </div>
            </div>

            <!-- Edit Word Modal -->
            <div id="edit-word-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeEditWordForm()">&times;</span>
                    <h3>Edit Word</h3>
                    <form id="edit-word-form" onsubmit="updateWord(event)">
                        <input type="hidden" id="edit-word-id">
                        <input type="text" id="edit-thai-word" placeholder="Thai word" required>
                        <input type="text" id="edit-pronunciation" placeholder="Pronunciation (English)" required>
                        <input type="text" id="edit-translation" placeholder="English translation" required>
                        <textarea id="edit-example" placeholder="Example usage (optional)"></textarea>
                        
                        <select id="edit-word-category" required>
                            <option value="">Select Category</option>
                        </select>
                        
                        <select id="edit-word-progress" required>
                            <option value="new">New</option>
                            <option value="recognise">Recognise</option>
                            <option value="recall">Recall</option>
                            <option value="confident">Confident</option>
                        </select>
                        
                        <button type="submit" class="action-btn">Update Word</button>
                    </form>
                </div>
            </div>
        `;
        
        populateCategoryDropdowns();
        displayVocabulary();
    }

    window.showPhrases = function() {
        setActiveNav(event.target);
        document.getElementById('page-title').textContent = 'Phrasebook';
        document.getElementById('main-content').innerHTML = `
            <div class="vocab-header">
                <button class="action-btn" onclick="showAddPhraseForm()" ${isLoading ? 'disabled' : ''}>+ Add New Phrase</button>
                
                <div class="filters">
                    <select id="phrase-category-filter" onchange="filterPhrases()" ${isLoading ? 'disabled' : ''}>
                        <option value="">All Categories</option>
                    </select>
                    
                    <select id="phrase-progress-filter" onchange="filterPhrases()" ${isLoading ? 'disabled' : ''}>
                        <option value="">All Progress Levels</option>
                        <option value="new">New</option>
                        <option value="recognise">Recognise</option>
                        <option value="recall">Recall</option>
                        <option value="confident">Confident</option>
                    </select>
                    
                    <input type="text" id="phrase-search-filter" placeholder="Search phrases..." onkeyup="filterPhrases()" ${isLoading ? 'disabled' : ''}>
                </div>
            </div>

            <div class="phrase-grid" id="phrase-grid">
                <!-- Phrase cards will be populated here -->
            </div>

            <!-- Add Phrase Modal -->
            <div id="add-phrase-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeAddPhraseForm()">&times;</span>
                    <h3>Add New Phrase</h3>
                    <form id="add-phrase-form" onsubmit="addPhrase(event)">
                        <input type="text" id="thai-phrase" placeholder="Thai phrase" required>
                        <input type="text" id="phrase-pronunciation" placeholder="Pronunciation (English)" required>
                        <input type="text" id="phrase-translation" placeholder="English translation" required>
                        <textarea id="phrase-context" placeholder="When/where to use this phrase (optional)"></textarea>
                        
                        <select id="phrase-category" required>
                            <option value="">Select Category</option>
                        </select>
                        
                        <select id="phrase-progress" required>
                            <option value="new">New</option>
                            <option value="recognise">Recognise</option>
                            <option value="recall">Recall</option>
                            <option value="confident">Confident</option>
                        </select>
                        
                        <button type="submit" class="action-btn">Add Phrase</button>
                    </form>
                </div>
            </div>

            <!-- Edit Phrase Modal -->
            <div id="edit-phrase-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeEditPhraseForm()">&times;</span>
                    <h3>Edit Phrase</h3>
                    <form id="edit-phrase-form" onsubmit="updatePhrase(event)">
                        <input type="hidden" id="edit-phrase-id">
                        <input type="text" id="edit-thai-phrase" placeholder="Thai phrase" required>
                        <input type="text" id="edit-phrase-pronunciation" placeholder="Pronunciation (English)" required>
                        <input type="text" id="edit-phrase-translation" placeholder="English translation" required>
                        <textarea id="edit-phrase-context" placeholder="When/where to use this phrase (optional)"></textarea>
                        
                        <select id="edit-phrase-category" required>
                            <option value="">Select Category</option>
                        </select>
                        
                        <select id="edit-phrase-progress" required>
                            <option value="new">New</option>
                            <option value="recognise">Recognise</option>
                            <option value="recall">Recall</option>
                            <option value="confident">Confident</option>
                        </select>
                        
                        <button type="submit" class="action-btn">Update Phrase</button>
                    </form>
                </div>
            </div>
        `;
        
        populateCategoryDropdowns();
        displayPhrases();
    }

    window.showTemplates = function() {
        setActiveNav(event.target);
        document.getElementById('page-title').textContent = 'Sentence Templates';
        document.getElementById('main-content').innerHTML = `
            <div class="vocab-header">
                <button class="action-btn" onclick="showAddTemplateForm()" ${isLoading ? 'disabled' : ''}>+ Add New Template</button>
                
                <div class="filters">
                    <select id="template-category-filter" onchange="filterTemplates()" ${isLoading ? 'disabled' : ''}>
                        <option value="">All Categories</option>
                    </select>
                    
                    <select id="template-complexity-filter" onchange="filterTemplates()" ${isLoading ? 'disabled' : ''}>
                        <option value="">All Complexity Levels</option>
                        <option value="basic">Basic</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                    
                    <input type="text" id="template-search-filter" placeholder="Search templates..." onkeyup="filterTemplates()" ${isLoading ? 'disabled' : ''}>
                </div>
            </div>

            <div class="vocab-grid" id="template-grid">
                <!-- Template cards will be populated here -->
            </div>

            <!-- Add Template Modal -->
            <div id="add-template-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeAddTemplateForm()">&times;</span>
                    <h3>Add New Template</h3>
                    <form id="add-template-form" onsubmit="addTemplate(event)">
                        <input type="text" id="template-pattern-thai" placeholder="Sentence pattern in Thai" required>
                        <input type="text" id="template-pattern-pronunciation" placeholder="Sentence pattern pronunciation (English)" required>
                        <textarea id="template-example" placeholder="Example sentence using this pattern (optional)"></textarea>
                        <textarea id="template-notes" placeholder="Grammar notes or usage tips (optional)"></textarea>
                        
                        <select id="template-category" required>
                            <option value="">Select Category</option>
                        </select>
                        
                        <select id="template-complexity" required>
                            <option value="basic">Basic</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                        
                        <button type="submit" class="action-btn">Add Template</button>
                    </form>
                </div>
            </div>

            <!-- Edit Template Modal -->
            <div id="edit-template-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeEditTemplateForm()">&times;</span>
                    <h3>Edit Template</h3>
                    <form id="edit-template-form" onsubmit="updateTemplate(event)">
                        <input type="hidden" id="edit-template-id">
                        <input type="text" id="edit-template-pattern-thai" placeholder="Sentence pattern in Thai" required>
                        <input type="text" id="edit-template-pattern-pronunciation" placeholder="Sentence pattern pronunciation (English)" required>
                        <textarea id="edit-template-example" placeholder="Example sentence (optional)"></textarea>
                        <textarea id="edit-template-notes" placeholder="Grammar notes (optional)"></textarea>
                        
                        <select id="edit-template-category" required>
                            <option value="">Select Category</option>
                        </select>
                        
                        <select id="edit-template-complexity" required>
                            <option value="basic">Basic</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                        
                        <button type="submit" class="action-btn">Update Template</button>
                    </form>
                </div>
            </div>
        `;
        
        populateCategoryDropdowns();
        displayTemplates();
    }

    window.showCategories = function() {
        setActiveNav(event.target);
        document.getElementById('page-title').textContent = 'Category Manager';
        document.getElementById('main-content').innerHTML = `
            <div class="category-header">
                <button class="action-btn" onclick="showAddCategoryForm()" ${isLoading ? 'disabled' : ''}>+ Add New Category</button>
            </div>

            <div class="category-list" id="category-list">
                <!-- Categories will be populated here -->
            </div>

            <!-- Add Category Modal -->
            <div id="add-category-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeAddCategoryForm()">&times;</span>
                    <h3>Add New Category</h3>
                    <form id="add-category-form" onsubmit="addCategory(event)">
                        <input type="text" id="category-name" placeholder="Category name" required>
                        <textarea id="category-description" placeholder="Description (optional)"></textarea>
                        <button type="submit" class="action-btn">Add Category</button>
                    </form>
                </div>
            </div>

            <!-- Edit Category Modal -->
            <div id="edit-category-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close" onclick="closeEditCategoryForm()">&times;</span>
                    <h3>Edit Category</h3>
                    <form id="edit-category-form" onsubmit="updateCategory(event)">
                        <input type="hidden" id="edit-category-id">
                        <input type="text" id="edit-category-name" placeholder="Category name" required>
                        <textarea id="edit-category-description" placeholder="Description (optional)"></textarea>
                        <button type="submit" class="action-btn">Update Category</button>
                    </form>
                </div>
            </div>
        `;
        
        displayCategories();
    }

    // Vocabulary Management Functions
    window.showAddWordForm = function() {
        populateCategoryDropdowns();
        document.getElementById('add-word-modal').style.display = 'block';
    }

    window.closeAddWordForm = function() {
        document.getElementById('add-word-modal').style.display = 'none';
        document.getElementById('add-word-form').reset();
    }

    window.addWord = async function(event) {
        event.preventDefault();
        
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            const wordData = {
                thai: document.getElementById('thai-word').value,
                pronunciation: document.getElementById('pronunciation').value,
                translation: document.getElementById('translation').value,
                example: document.getElementById('example').value,
                category: document.getElementById('word-category').value,
                progress: document.getElementById('word-progress').value
            };
            
            await addWordToFirebase(wordData);
            closeAddWordForm();
            displayVocabulary();
            
        } catch (error) {
            alert('Error adding word: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    window.editWord = function(id) {
        const word = vocabulary.find(w => w.id === id);
        if (!word) return;
        
        populateCategoryDropdowns();
        
        document.getElementById('edit-word-id').value = word.id;
        document.getElementById('edit-thai-word').value = word.thai;
        document.getElementById('edit-pronunciation').value = word.pronunciation;
        document.getElementById('edit-translation').value = word.translation;
        document.getElementById('edit-example').value = word.example || '';
        document.getElementById('edit-word-category').value = word.category;
        document.getElementById('edit-word-progress').value = word.progress;
        
        document.getElementById('edit-word-modal').style.display = 'block';
    }

    window.closeEditWordForm = function() {
        document.getElementById('edit-word-modal').style.display = 'none';
        document.getElementById('edit-word-form').reset();
    }

    window.updateWord = async function(event) {
        event.preventDefault();
        
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            const wordId = document.getElementById('edit-word-id').value;
            const wordData = {
                thai: document.getElementById('edit-thai-word').value,
                pronunciation: document.getElementById('edit-pronunciation').value,
                translation: document.getElementById('edit-translation').value,
                example: document.getElementById('edit-example').value,
                category: document.getElementById('edit-word-category').value,
                progress: document.getElementById('edit-word-progress').value
            };
            
            await updateWordInFirebase(wordId, wordData);
            closeEditWordForm();
            displayVocabulary();
            
        } catch (error) {
            alert('Error updating word: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    window.deleteWord = async function(id) {
        if (!confirm('Are you sure you want to delete this word?')) return;
        try {
            await deleteWordFromFirebase(id);
            displayVocabulary();
        } catch (error) {
            alert('Error deleting word: ' + error.message);
         }
     }

   function displayVocabulary() {
    const grid = document.getElementById('vocab-grid');
    if (!grid) return;
    
    let filteredVocab = [...vocabulary];
    
    const categoryFilter = document.getElementById('category-filter')?.value;
    const progressFilter = document.getElementById('progress-filter')?.value;
    const searchFilter = document.getElementById('search-filter')?.value.toLowerCase();
    
    if (categoryFilter) {
        filteredVocab = filteredVocab.filter(word => word.category === categoryFilter);
    }
    
    if (progressFilter) {
        filteredVocab = filteredVocab.filter(word => word.progress === progressFilter);
    }
    
    if (searchFilter) {
        filteredVocab = filteredVocab.filter(word => 
            word.thai.toLowerCase().includes(searchFilter) ||
            word.translation.toLowerCase().includes(searchFilter) ||
            word.pronunciation.toLowerCase().includes(searchFilter)
        );
    }
    
    if (filteredVocab.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #7f8c8d; grid-column: 1 / -1;">No vocabulary words found.</p>';
        return;
    }
    
    grid.innerHTML = filteredVocab.map(word => {
        const category = categories.find(c => c.id === word.category);
        return `
            <div class="vocab-card">
                <div class="vocab-card-header">
                    <div>
                        <div class="thai-word">${word.thai}</div>
                        <div class="pronunciation">${word.pronunciation}</div>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn edit-btn" onclick="editWord('${word.id}')" title="Edit" ${isLoading ? 'disabled' : ''}>✏️</button>
                        <button class="card-btn delete-btn" onclick="deleteWord('${word.id}')" title="Delete" ${isLoading ? 'disabled' : ''}>🗑️</button>
                    </div>
                </div>
                
                <div class="translation">${word.translation}</div>
                
                ${word.example ? `<div class="example">"${word.example}"</div>` : ''}
                
                <div class="card-meta">
                    <div>
                        <span class="progress-badge progress-${word.progress}">${word.progress}</span>
                        <span class="category-badge">${category ? category.name : 'Unknown'}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

window.filterVocabulary = function() {
    displayVocabulary();
}

// Phrase Management Functions
window.showAddPhraseForm = function() {
    populateCategoryDropdowns();
    document.getElementById('add-phrase-modal').style.display = 'block';
}

window.closeAddPhraseForm = function() {
    document.getElementById('add-phrase-modal').style.display = 'none';
    document.getElementById('add-phrase-form').reset();
}

window.addPhrase = async function(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
        
        const phraseData = {
            thai: document.getElementById('thai-phrase').value,
            pronunciation: document.getElementById('phrase-pronunciation').value,
            translation: document.getElementById('phrase-translation').value,
            context: document.getElementById('phrase-context').value,
            category: document.getElementById('phrase-category').value,
            progress: document.getElementById('phrase-progress').value
        };
        
        await addPhraseToFirebase(phraseData);
        closeAddPhraseForm();
        displayPhrases();
        
    } catch (error) {
        alert('Error adding phrase: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

window.editPhrase = function(id) {
    const phrase = phrases.find(p => p.id === id);
    if (!phrase) return;
    
    populateCategoryDropdowns();
    
    document.getElementById('edit-phrase-id').value = phrase.id;
    document.getElementById('edit-thai-phrase').value = phrase.thai;
    document.getElementById('edit-phrase-pronunciation').value = phrase.pronunciation;
    document.getElementById('edit-phrase-translation').value = phrase.translation;
    document.getElementById('edit-phrase-context').value = phrase.context || '';
    document.getElementById('edit-phrase-category').value = phrase.category;
    document.getElementById('edit-phrase-progress').value = phrase.progress;
    
    document.getElementById('edit-phrase-modal').style.display = 'block';
}

window.closeEditPhraseForm = function() {
    document.getElementById('edit-phrase-modal').style.display = 'none';
    document.getElementById('edit-phrase-form').reset();
}

window.updatePhrase = async function(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';
        
        const phraseId = document.getElementById('edit-phrase-id').value;
        const phraseData = {
            thai: document.getElementById('edit-thai-phrase').value,
            pronunciation: document.getElementById('edit-phrase-pronunciation').value,
            translation: document.getElementById('edit-phrase-translation').value,
            context: document.getElementById('edit-phrase-context').value,
            category: document.getElementById('edit-phrase-category').value,
            progress: document.getElementById('edit-phrase-progress').value
        };
        
        await updatePhraseInFirebase(phraseId, phraseData);
        closeEditPhraseForm();
        displayPhrases();
        
    } catch (error) {
        alert('Error updating phrase: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

window.deletePhrase = async function(id) {
    if (!confirm('Are you sure you want to delete this phrase?')) return;
    
    try {
        await deletePhraseFromFirebase(id);
        displayPhrases();
    } catch (error) {
        alert('Error deleting phrase: ' + error.message);
    }
}

function displayPhrases() {
    const grid = document.getElementById('phrase-grid');
    if (!grid) return;
    
    let filteredPhrases = [...phrases];
    
    const categoryFilter = document.getElementById('phrase-category-filter')?.value;
    const progressFilter = document.getElementById('phrase-progress-filter')?.value;
    const searchFilter = document.getElementById('phrase-search-filter')?.value.toLowerCase();
    
    if (categoryFilter) {
        filteredPhrases = filteredPhrases.filter(phrase => phrase.category === categoryFilter);
    }
    
    if (progressFilter) {
        filteredPhrases = filteredPhrases.filter(phrase => phrase.progress === progressFilter);
    }
    
    if (searchFilter) {
        filteredPhrases = filteredPhrases.filter(phrase => 
            phrase.thai.toLowerCase().includes(searchFilter) ||
            phrase.translation.toLowerCase().includes(searchFilter) ||
            phrase.pronunciation.toLowerCase().includes(searchFilter)
        );
    }
    
    if (filteredPhrases.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #7f8c8d; grid-column: 1 / -1;">No phrases found.</p>';
        return;
    }
    
    grid.innerHTML = filteredPhrases.map(phrase => {
        const category = categories.find(c => c.id === phrase.category);
        return `
            <div class="vocab-card">
                <div class="vocab-card-header">
                    <div>
                        <div class="thai-word">${phrase.thai}</div>
                        <div class="pronunciation">${phrase.pronunciation}</div>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn edit-btn" onclick="editPhrase('${phrase.id}')" title="Edit" ${isLoading ? 'disabled' : ''}>✏️</button>
                        <button class="card-btn delete-btn" onclick="deletePhrase('${phrase.id}')" title="Delete" ${isLoading ? 'disabled' : ''}>🗑️</button>
                    </div>
                </div>
                
                <div class="translation">${phrase.translation}</div>
                
                ${phrase.context ? `<div class="example">Context: "${phrase.context}"</div>` : ''}
                
                <div class="card-meta">
                    <div>
                        <span class="progress-badge progress-${phrase.progress}">${phrase.progress}</span>
                        <span class="category-badge">${category ? category.name : 'Unknown'}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

window.filterPhrases = function() {
    displayPhrases();
}

// Template Management Functions
window.showAddTemplateForm = function() {
    populateCategoryDropdowns();
    document.getElementById('add-template-modal').style.display = 'block';
}

window.closeAddTemplateForm = function() {
    document.getElementById('add-template-modal').style.display = 'none';
    document.getElementById('add-template-form').reset();
}

window.addTemplate = async function(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
        
        const templateData = {
            patternThai: document.getElementById('template-pattern-thai').value,
            patternPronunciation: document.getElementById('template-pattern-pronunciation').value,
            example: document.getElementById('template-example').value,
            notes: document.getElementById('template-notes').value,
            category: document.getElementById('template-category').value,
            complexity: document.getElementById('template-complexity').value
        };
        
        await addTemplateToFirebase(templateData);
        closeAddTemplateForm();
        displayTemplates();
        
    } catch (error) {
        alert('Error adding template: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

window.editTemplate = function(id) {
    const template = templates.find(t => t.id === id);
    if (!template) return;
    
    populateCategoryDropdowns();
    
    document.getElementById('edit-template-id').value = template.id;
    document.getElementById('edit-template-pattern-thai').value = template.patternThai || template.pattern || '';
    document.getElementById('edit-template-pattern-pronunciation').value = template.patternPronunciation || '';
    document.getElementById('edit-template-example').value = template.example || '';
    document.getElementById('edit-template-notes').value = template.notes || '';
    document.getElementById('edit-template-category').value = template.category;
    document.getElementById('edit-template-complexity').value = template.complexity;
    
    document.getElementById('edit-template-modal').style.display = 'block';
}

window.closeEditTemplateForm = function() {
    document.getElementById('edit-template-modal').style.display = 'none';
    document.getElementById('edit-template-form').reset();
}

window.updateTemplate = async function(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';
        
        const templateId = document.getElementById('edit-template-id').value;
        const templateData = {
            patternThai: document.getElementById('edit-template-pattern-thai').value,
            patternPronunciation: document.getElementById('edit-template-pattern-pronunciation').value,
            example: document.getElementById('edit-template-example').value,
            notes: document.getElementById('edit-template-notes').value,
            category: document.getElementById('edit-template-category').value,
            complexity: document.getElementById('edit-template-complexity').value
        };
        
        await updateTemplateInFirebase(templateId, templateData);
        closeEditTemplateForm();
        displayTemplates();
        
    } catch (error) {
        alert('Error updating template: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

window.deleteTemplate = async function(id) {
    if (!confirm('Are you sure you want to delete this template?')) return;
    
    try {
        await deleteTemplateFromFirebase(id);
        displayTemplates();
    } catch (error) {
        alert('Error deleting template: ' + error.message);
    }
}

function displayTemplates() {
    const grid = document.getElementById('template-grid');
    if (!grid) return;
    
    let filteredTemplates = [...templates];
    
    const categoryFilter = document.getElementById('template-category-filter')?.value;
    const complexityFilter = document.getElementById('template-complexity-filter')?.value;
    const searchFilter = document.getElementById('template-search-filter')?.value.toLowerCase();
    
    if (categoryFilter) {
        filteredTemplates = filteredTemplates.filter(template => template.category === categoryFilter);
    }
    
    if (complexityFilter) {
        filteredTemplates = filteredTemplates.filter(template => template.complexity === complexityFilter);
    }
    
    if (searchFilter) {
        filteredTemplates = filteredTemplates.filter(template => 
            (template.patternThai && template.patternThai.toLowerCase().includes(searchFilter)) ||
            (template.patternPronunciation && template.patternPronunciation.toLowerCase().includes(searchFilter)) ||
            (template.example && template.example.toLowerCase().includes(searchFilter)) ||
            (template.pattern && template.pattern.toLowerCase().includes(searchFilter)) // For backwards compatibility
        );
    }
    
    if (filteredTemplates.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #7f8c8d; grid-column: 1 / -1;">No templates found.</p>';
        return;
    }
    
    grid.innerHTML = filteredTemplates.map(template => {
        const category = categories.find(c => c.id === template.category);
        // Handle both new format (patternThai) and old format (pattern) for backwards compatibility
        const displayPattern = template.patternThai || template.pattern || '';
        const displayPronunciation = template.patternPronunciation || 'Pattern';
        
        return `
            <div class="vocab-card">
                <div class="vocab-card-header">
                    <div>
                        <div class="thai-word">${displayPattern}</div>
                        <div class="pronunciation">${displayPronunciation}</div>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn edit-btn" onclick="editTemplate('${template.id}')" title="Edit" ${isLoading ? 'disabled' : ''}>✏️</button>
                        <button class="card-btn delete-btn" onclick="deleteTemplate('${template.id}')" title="Delete" ${isLoading ? 'disabled' : ''}>🗑️</button>
                    </div>
                </div>
                
                ${template.example ? `<div class="translation">Example: ${template.example}</div>` : ''}
                
                ${template.notes ? `<div class="example">Notes: "${template.notes}"</div>` : ''}
                
                <div class="card-meta">
                    <div>
                        <span class="progress-badge progress-${template.complexity}">${template.complexity}</span>
                        <span class="category-badge">${category ? category.name : 'Unknown'}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

window.filterTemplates = function() {
    displayTemplates();
}

// Category Management Functions
window.showAddCategoryForm = function() {
    document.getElementById('add-category-modal').style.display = 'block';
}

window.closeAddCategoryForm = function() {
    document.getElementById('add-category-modal').style.display = 'none';
    document.getElementById('add-category-form').reset();
}

window.addCategory = async function(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';
        
        const categoryData = {
            name: document.getElementById('category-name').value,
            description: document.getElementById('category-description').value
        };
        
        await addCategoryToFirebase(categoryData);
        closeAddCategoryForm();
        displayCategories();
        
    } catch (error) {
        alert('Error adding category: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

window.editCategory = function(id) {
    const category = categories.find(c => c.id === id);
    if (!category) return;
    
    document.getElementById('edit-category-id').value = category.id;
    document.getElementById('edit-category-name').value = category.name;
    document.getElementById('edit-category-description').value = category.description || '';
    
    document.getElementById('edit-category-modal').style.display = 'block';
}

window.closeEditCategoryForm = function() {
    document.getElementById('edit-category-modal').style.display = 'none';
    document.getElementById('edit-category-form').reset();
}

window.updateCategory = async function(event) {
    event.preventDefault();
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';
        
        const categoryId = document.getElementById('edit-category-id').value;
        const categoryData = {
            name: document.getElementById('edit-category-name').value,
            description: document.getElementById('edit-category-description').value
        };
        
        await updateCategoryInFirebase(categoryId, categoryData);
        closeEditCategoryForm();
        displayCategories();
        
    } catch (error) {
        alert('Error updating category: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

window.deleteCategory = async function(id) {
    const wordsInCategory = vocabulary.filter(w => w.category === id);
    const phrasesInCategory = phrases.filter(p => p.category === id);
    const templatesInCategory = templates.filter(t => t.category === id);
    const totalItems = wordsInCategory.length + phrasesInCategory.length + templatesInCategory.length;
    
    if (totalItems > 0) {
        if (!confirm(`This category has ${totalItems} items. Delete anyway? Items will become uncategorized.`)) {
            return;
        }
    } else if (!confirm('Are you sure you want to delete this category?')) {
        return;
    }
    
    try {
        await deleteCategoryFromFirebase(id);
        displayCategories();
        
        // Refresh other views if they're currently displayed
        if (document.getElementById('vocab-grid')) displayVocabulary();
        if (document.getElementById('phrase-grid')) displayPhrases();
        if (document.getElementById('template-grid')) displayTemplates();
        
    } catch (error) {
        alert('Error deleting category: ' + error.message);
    }
}

function displayCategories() {
    const list = document.getElementById('category-list');
    if (!list) return;
    
    if (categories.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No categories found. Add your first category!</p>';
        return;
    }
    
    list.innerHTML = categories.map(category => {
        const wordCount = vocabulary.filter(w => w.category === category.id).length;
        const phraseCount = phrases.filter(p => p.category === category.id).length;
        const templateCount = templates.filter(t => t.category === category.id).length;
        const totalCount = wordCount + phraseCount + templateCount;
        
        return `
            <div class="category-item">
                <div class="category-info">
                    <h3>${category.name}</h3>
                    <p>${category.description || 'No description'} • ${totalCount} items (${wordCount} words, ${phraseCount} phrases, ${templateCount} templates)</p>
                </div>
                <div class="category-actions">
                    <button class="category-btn edit-category-btn" onclick="editCategory('${category.id}')" ${isLoading ? 'disabled' : ''}>Edit</button>
                    <button class="category-btn delete-category-btn" onclick="deleteCategory('${category.id}')" ${isLoading ? 'disabled' : ''}>Delete</button>
                </div>
            </div>
        `;
    }).join('');
}

// Utility Functions
function populateCategoryDropdowns() {
    const selects = ['word-category', 'edit-word-category', 'phrase-category', 'edit-phrase-category', 'template-category', 'edit-template-category'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Category</option>' +
                categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            select.value = currentValue;
        }
    });

    // Also populate filter dropdowns
    const filterSelects = ['category-filter', 'phrase-category-filter', 'template-category-filter'];
    filterSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Categories</option>' +
                categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            select.value = currentValue;
        }
    });
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}

// Initialize Firebase and load data after authentication
window.addEventListener('load', function() {
    // Show loading while checking authentication state
    document.getElementById('main-content').innerHTML = '<div class="loading">Checking authentication...</div>';
    
    // Wait for Firebase to determine auth state
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is already logged in - load the app
            currentUser = user;
            document.getElementById('login-modal').style.display = 'none';
            
            try {
                await loadAllData();
                showDashboard();
                console.log('Auto-login successful for:', user.email);
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data. Please refresh the page.');
            }
        } else {
            // No user logged in - show login form
            document.getElementById('login-modal').style.display = 'block';
            document.getElementById('main-content').innerHTML = '<div class="loading">Please login to continue...</div>';
        }
        
        // Clean up the listener after first check
        unsubscribe();
    });
});
     
    </script>

</body>
</html>